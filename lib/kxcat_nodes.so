####################################
# Kage Park
# Re-designed(2017/09) by Kage Park
# Base design Using old xcat scripts(2011) of Kage
# License : GPL
####################################

hosts() {
   nodels
}

nodes() {
   srv_num=1
   xor=0
   mx_item=5 

   printf "%8s " "Nodes"
   printf "%15s " "Hostname"
   printf "%15s " "Alias"
   printf "%10s " "Power"
   printf "%10s " "OS State"
   echo

   node_list=()
   for line in $(echo $(lsdef -t node -o all -i id,power,status,hostnames,statustime) | sed -e "s/currstate=//g" -e "s/hostnames=//g" -e "s/id=//g" -e "s/status=//g" -e "s/power=//g" -e "s/statustime=//g" -e "s/ /,/g" | sed "s/Object,name:,/\n/g"); do
       id=$(echo $line | awk -F, '{print $3}')
#       node_list[$id]="$(echo $line | awk -F, '{printf "%s,%s,%s,%s",$1,$2,$4,$5}')"
       node_list[$id]="$line"
   done

   for ((ii=1;ii<=${#node_list[*]};ii++)); do
       node_name=N$(printf "%05d" $ii)
       host_name=$(echo ${node_list[$ii]} | awk -F, '{print $1}')
       printf "%8s " $node_name
       [ "$node_name" == "$host_name" ] &&  printf "%15s " "-" || printf "%15s " "$(echo ${node_list[$ii]} | awk -F, '{print $1}')"
       printf "%15s " "$(echo ${node_list[$ii]} | awk -F, '{print $2}')"
       printf "%10s " "$(echo ${node_list[$ii]} | awk -F, '{print $4}')"
       boot_mode=$(echo ${node_list[$ii]} | awk -F, '{print $5}')
       if [ "$boot_mode" == "booted" ]; then
          boot_date=$(echo ${node_list[$ii]} | awk -F, '{printf "%s %s",$6,$7}' | sed "s/-/\//g")
          boot_status_time=$(date -d "$boot_date" +%s)
          now_time=$(date +%s)
          (( $(( $now_time - $((400 * 2)) )) > $boot_status_time )) && boot_mode="unknown"
       fi
       printf "%10s " "$boot_mode"
       echo
   done
}
