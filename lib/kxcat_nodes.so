####################################
# Kage Park
# Re-designed(2017/09) by Kage Park
# Base design Using old xcat scripts(2011) of Kage
# License : GPL
####################################

hosts() {
   nodels
}

nodes() {
   srv_num=1
   xor=0
   mx_item=5 

   printf "%8s " "Nodes"
   printf "%15s " "Hostname"
   printf "%15s " "Alias"
   printf "%10s " "Mode"
   printf "%10s " "Power"
   printf "%10s " "OS State"
   echo

   node_list=()
   while read x ; do 
       id=$(echo $x | awk -F, '{print $4}'); 
       [ -n "$id" ] && node_list[$id]=$x; 
   done < <(echo $(lsdef -t node -o all -i id,power,status,hostnames,status,currstate,statustime) | sed -e "s/currstate=/,/g" -e "s/hostnames=/,/g" -e "s/id=/,/g" -e "s/status=/,/g" -e "s/power=/,/g" -e "s/statustime=/,/g" | sed "s/Object name: /\n/g" | sed "s/ ,/,/g")

   for ((ii=1;ii<=${#node_list[*]};ii++)); do
       node_name=n$(printf "%05d" $ii)
       host_name=$(echo ${node_list[$ii]} | awk -F, '{print $1}')
       printf "%8s " $node_name
       [ "$node_name" == "$host_name" ] && host_name="-" || host_name=$(echo ${node_list[$ii]} | awk -F, '{print $1}')
       printf "%15s " "$host_name"
       printf "%15s " "$(echo ${node_list[$ii]} | awk -F, '{print $3}')"
       [ "$host_name" == "-" ] && printf "%10s " "-" || \
       printf "%10s " "$(booting_mode=$(echo ${node_list[$ii]} | awk -F, '{print $2}' |awk '{print $1}'); [ -n "$booting_mode" ] && echo $booting_mode || echo "-")"
       printf "%10s " "$(echo ${node_list[$ii]} | awk -F, '{print $5}')"
       boot_mode=$(echo ${node_list[$ii]} | awk -F, '{print $6}')
       if [ "$boot_mode" == "booted" ]; then
          boot_date=$(echo ${node_list[$ii]} | awk -F, '{print $7}' | sed "s/-/\//g")
          boot_status_time=$(date -d "$boot_date" +%s)
          now_time=$(date +%s)
          (( $(( $now_time - $((400 * 2)) )) > $boot_status_time )) && boot_mode="unknown"
       fi
       printf "%10s " "$boot_mode"
       echo
   done
}
