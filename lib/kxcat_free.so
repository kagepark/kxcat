####################################
# License : GPL
####################################
free() {
   local hostname opt
   opt=($*)
   if (( ${#opt[*]} < 1 )); then
         echo "${FUNCNAME} <group name> [<host count#> [<hostname1> <hostname2>...]]"
         exit
   fi
   for group in $*; do
   if ! lsdef -t group $group >& /dev/null; then
        echo "group $group  not found"
        exit
   fi

   shift 1
   node_count=$1
   _k_misc_is_num $node_count >& /dev/null || hosts=($(lsdef -t group ${group} |grep "members=" | awk -F= '{print $2}' | sed "s/,/ /g"))
   shift 1
   if [ -n "$hosts" ]; then
      node_count=${#hosts[*]}
   else
      hosts=($*)
   fi

   (( ${#hosts[*]} == 0 )) && hosts=($(lsdef -t group ${group} |grep members | awk -F= '{print $2}' | sed "s/,/ /g"))
   (( ${#hosts[*]} == 0 )) && error_exit "Can't find hosts list"
   #node_list=($( echo $(echo $(lsdef $(echo ${hosts[*]} | sed "s/ /,/g") -i id | sed -e "s/ //g" -e "s/id=/:/g") | sed "s/ //g" | sed "s/Objectname:/\n/g")))

   node_list=$(echo $(echo $(lsdef $(echo $hosts|sed "s/ /,/g") -i id,status |sed -e "s/status=/:/g" -e "s/id=/:/g")| sed "s/ //g" | sed "s/Objectname:/\n/g" | grep -v -e ":installing$" -e ":maint$" | awk -F: '{print $1}') | sed "s/ /,/g")

   (( $node_count > ${#node_list[*]} )) && error_exit "Please reduce <host count#> number to lower hosts number"
   delhosts=""
   delnodes=""
   for ((ii=$((${#node_list[*]}-1)); ii>=$((${#node_list[*]} - $node_count)); ii--)); do
       hostname=$(echo ${node_list[$ii]} | awk -F: '{print $1}')
       hostid=$(echo ${node_list[$ii]} | awk -F: '{print $2}')
       [ -n "$delnodes" ] && delnodes="$delnodes,${hostname}" || delnodes="${hostname}"
   done
   _k_load xcat_power
   power off ${delnodes} 2>/dev/null
   makehosts -d ${delnodes} 2>/dev/null
   makedns -d ${delnodes} 2>/dev/null
   makedhcp -d ${delnodes} 2>/dev/null
   makeconservercf -d ${delnodes} 2>/dev/null

   for ((ii=$((${#node_list[*]}-1)); ii>=$((${#node_list[*]} - $node_count)); ii--)); do
       hostname=$(echo ${node_list[$ii]} | awk -F: '{print $1}')
       hostid=$(echo ${node_list[$ii]} | awk -F: '{print $2}')
       if ! chdef -t node -o $hostname -n n$(printf "%05d" $hostid) $ii; then
            makehosts ${hostname} >&/dev/null
            makedns ${hotsname} >&/dev/null
            makedhcp ${hostname} >&/dev/null 
            makeconservercf ${hostname} >&/dev/null
            continue
       fi
       sed -i "/host ${hostname} {/,/^}/d" /var/lib/dhcpd/dhcpd.leases
       rm -f /install/autoinst/${hostname}*
       rm -f /tftpboot/xcat/xnba/nodes/${hostname}*
       rm -f /tftpboot/mypostscripts/mypostscript.${hostname}
       [ -n "$delhosts" ] && delhosts="$delhosts,n$(printf "%05d" $hostid)" || delhosts=n$(printf "%05d" $hostid)
   done 
   chdef -t node $delhosts groups=all,n status=
   done
}
